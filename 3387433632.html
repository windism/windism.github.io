

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="windism">
  <meta name="keywords" content="Spark">
  
    <meta name="description" content="Spark 2.4.X 无法读取 Hive 数据 场景分析: Hive 部分数据表存在数据, Spark 2.1.1 可以读取, 但是 Spark 2.4.X 无法读取 分析过程:  针对可读取数据表和不可读取数据表进行分析  hadoop fs -ls -R can_read_table_path | awk &#39;&amp;#123;print $8&amp;#125;&#39; | awk -F&#x2F; &#39;&amp;#123;pri">
<meta property="og:type" content="article">
<meta property="og:title" content="【Spark笔记】 日常踩坑">
<meta property="og:url" content="https://www.windism.space/3387433632.html">
<meta property="og:site_name" content="风扬技术站">
<meta property="og:description" content="Spark 2.4.X 无法读取 Hive 数据 场景分析: Hive 部分数据表存在数据, Spark 2.1.1 可以读取, 但是 Spark 2.4.X 无法读取 分析过程:  针对可读取数据表和不可读取数据表进行分析  hadoop fs -ls -R can_read_table_path | awk &#39;&amp;#123;print $8&amp;#125;&#39; | awk -F&#x2F; &#39;&amp;#123;pri">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-06-07T08:53:08.000Z">
<meta property="article:modified_time" content="2022-06-28T14:14:42.000Z">
<meta property="article:author" content="windism">
<meta property="article:tag" content="Spark">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>【Spark笔记】 日常踩坑 - 风扬技术站</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.windism.space","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"2eac19870ffb3538ed048a88632c0e62","google":{"measurement_id":"G-5840CXGFGL"},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2eac19870ffb3538ed048a88632c0e62";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-5840CXGFGL", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-5840CXGFGL');
        });
      }
    </script>
  

  

  

  

  



  <meta name="google-adsense-account" content="ca-pub-1519148638782253">
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="风扬技术站" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="风扬技术站" type="application/rss+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>风扬技术站</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="【Spark笔记】 日常踩坑"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-06-07 16:53" pubdate>
          2021年6月7日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          52 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">【Spark笔记】 日常踩坑</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="Spark-2-4-X-无法读取-Hive-数据">Spark 2.4.X 无法读取 Hive 数据</h2>
<p>场景分析: Hive 部分数据表存在数据, Spark 2.1.1 可以读取, 但是 Spark 2.4.X 无法读取</p>
<p>分析过程:</p>
<ol>
<li>针对可读取数据表和不可读取数据表进行分析</li>
</ol>
<figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">hadoop fs -ls -R can_read_table_path | awk '&#123;print $8&#125;' | awk -F/ '&#123;printf " |-";for(i=3;i&lt;NF;i++)&#123;printf "--"&#125; print $NF&#125;'
 |---------------000000_0
 |---------------000001_0
 |---------------000002_0
hadoop fs -ls -R cannot_read_table_path | awk '&#123;print $8&#125;' | awk -F/ '&#123;printf " |-";for(i=3;i&lt;NF;i++)&#123;printf "--"&#125; print $NF&#125;'
 |-------------HIVE_UNION_SUBDIR_1
 |---------------000000_0
 |---------------000001_0
 |---------------000002_0
 |-------------HIVE_UNION_SUBDIR_2
 |---------------000000_0
 |---------------000001_0
 |---------------000002_0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<blockquote>
<p>此时可以看出两者的文件目录结构不同, 估计该部分是两个数据在不同版本无法读取的主要原因, 即高版本 Spark 并未设置递归读</p>
</blockquote>
<ol start="2">
<li>针对 Spark 2.4.X 进行参数设置(Google)</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20756561/how-to-pick-up-all-data-into-hive-from-subdirectories">How to pick up all data into hive from subdirectories</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/myg821561935/article/details/78071014">Hive on tez的insert union 子目录的问题</a></li>
</ul>
<p>通过上述资料, 可以知道需要设置如下参数:</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> hive<span class="token punctuation">.</span>mapred<span class="token punctuation">.</span>supports<span class="token punctuation">.</span>subdirectories<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> mapred<span class="token punctuation">.</span>input<span class="token punctuation">.</span>dir<span class="token punctuation">.</span>recursive<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> mapreduce<span class="token punctuation">.</span>input<span class="token punctuation">.</span>fileinputformat<span class="token punctuation">.</span>input<span class="token punctuation">.</span>dir<span class="token punctuation">.</span>recursive<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>
<p>但是不管用, 针对 Hive 是起作用的(因为系统本身 Hive 已经设置如上参数啦~).</p>
<ol start="3">
<li>分析 Spark 2.1.1 到 Spark 2.4.X 之间针对 Hive 部分的改造</li>
</ol>
<blockquote>
<p>分析原因在于两个 Spark 基本上共用同一份 Hive 和 Spark 设置, 并处于同一 Yarn 平台上, 两者 DIFF 情况应当在于 Spark 高版本的某些优化导致的</p>
</blockquote>
<p>通过对更新日志和Spark JIRA搜索, 定位问题可能是由于spark.sql.hive.convertMetastoreOrc参数默认值的变化</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://spark.apache.org/docs/2.4.0/sql-migration-guide-upgrade.html">Spark SQL Upgrading Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/SPARK-28098">SPARK-28098</a></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">In version 2.3 and earlier, Spark converts Parquet Hive tables by default but ignores table properties like . This happens for ORC Hive table properties like in case of , too. Since Spark 2.4, Spark respects Parquet/ORC specific table properties while converting Parquet/ORC Hive tables. As an example, would generate Snappy parquet files during insertion in Spark 2.3, and in Spark 2.4, the result would be uncompressed parquet files.TBLPROPERTIES (parquet.compression 'NONE')TBLPROPERTIES (orc.compress 'NONE')spark.sql.hive.convertMetastoreOrc=trueCREATE TABLE t(id int) STORED AS PARQUET TBLPROPERTIES (parquet.compression 'NONE')

Since Spark 2.0, Spark converts Parquet Hive tables by default for better performance. Since Spark 2.4, Spark converts ORC Hive tables by default, too. It means Spark uses its own ORC support by default instead of Hive SerDe. As an example, would be handled with Hive SerDe in Spark 2.3, and in Spark 2.4, it would be converted into Spark’s ORC data source table and ORC vectorization would be applied. To set to restores the previous behavior.CREATE TABLE t(id int) STORED AS ORCfalsespark.sql.hive.convertMetastoreOrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>
<blockquote>
<p>更新记录含义: Spark 2.4 以后, Spark将采用自身的 SerDe 而非采用 Hive 的SerDe 处理 Hive 的 ORC 数据表(SerDe是Serialize/Deserilize的简称,目的是用于序列化和反序列化)</p>
</blockquote>
<ol start="4">
<li>定位 Spark 源码</li>
</ol>
<p>根源代码在于: <a target="_blank" rel="noopener" href="https://github.com/apache/spark/blob/v2.4.6/sql/hive/src/main/scala/org/apache/spark/sql/hive/HiveStrategies.scala">HiveStrategies.scala</a>中 <code>RelationConversions</code> 类, 可以看到根据配置不同, 对于 ORC 文件采用 <code>org.apache.spark.sql.execution.datasources.orc.OrcFileFormat</code> 或 <code>org.apache.spark.sql.hive.orc.OrcFileFormat</code> 处理方式, 其中采用 <code>org.apache.spark.sql.execution.datasources.orc.OrcFileFormat</code> 会导致如上问题. 并未对比两个的区别, 有兴趣的同学可以查看一下~</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> RelationConversions<span class="token punctuation">(</span>
    conf<span class="token operator">:</span> SQLConf<span class="token punctuation">,</span>
    sessionCatalog<span class="token operator">:</span> HiveSessionCatalog<span class="token punctuation">)</span> <span class="token keyword">extends</span> Rule<span class="token punctuation">[</span>LogicalPlan<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">def</span> convert<span class="token punctuation">(</span>relation<span class="token operator">:</span> HiveTableRelation<span class="token punctuation">)</span><span class="token operator">:</span> LogicalRelation <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">val</span> serde <span class="token operator">=</span> relation<span class="token punctuation">.</span>tableMeta<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>serde<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLowerCase<span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span>

    <span class="token comment">// Consider table and storage properties. For properties existing in both sides, storage</span>
    <span class="token comment">// properties will supersede table properties.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>serde<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">"parquet"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">val</span> options <span class="token operator">=</span> relation<span class="token punctuation">.</span>tableMeta<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>filterKeys<span class="token punctuation">(</span>isParquetProperty<span class="token punctuation">)</span> <span class="token operator">++</span>
        relation<span class="token punctuation">.</span>tableMeta<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>properties <span class="token operator">+</span> <span class="token punctuation">(</span>ParquetOptions<span class="token punctuation">.</span>MERGE_SCHEMA <span class="token operator">-></span>
        conf<span class="token punctuation">.</span>getConf<span class="token punctuation">(</span>HiveUtils<span class="token punctuation">.</span>CONVERT_METASTORE_PARQUET_WITH_SCHEMA_MERGING<span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">)</span>
      sessionCatalog<span class="token punctuation">.</span>metastoreCatalog
        <span class="token punctuation">.</span>convertToLogicalRelation<span class="token punctuation">(</span>relation<span class="token punctuation">,</span> options<span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>ParquetFileFormat<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"parquet"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">val</span> options <span class="token operator">=</span> relation<span class="token punctuation">.</span>tableMeta<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>filterKeys<span class="token punctuation">(</span>isOrcProperty<span class="token punctuation">)</span> <span class="token operator">++</span>
        relation<span class="token punctuation">.</span>tableMeta<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>properties
      <span class="token keyword">if</span> <span class="token punctuation">(</span>conf<span class="token punctuation">.</span>getConf<span class="token punctuation">(</span>SQLConf<span class="token punctuation">.</span>ORC_IMPLEMENTATION<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"native"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sessionCatalog<span class="token punctuation">.</span>metastoreCatalog<span class="token punctuation">.</span>convertToLogicalRelation<span class="token punctuation">(</span>
          relation<span class="token punctuation">,</span>
          options<span class="token punctuation">,</span>
          classOf<span class="token punctuation">[</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>execution<span class="token punctuation">.</span>datasources<span class="token punctuation">.</span>orc<span class="token punctuation">.</span>OrcFileFormat<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"orc"</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        sessionCatalog<span class="token punctuation">.</span>metastoreCatalog<span class="token punctuation">.</span>convertToLogicalRelation<span class="token punctuation">(</span>
          relation<span class="token punctuation">,</span>
          options<span class="token punctuation">,</span>
          classOf<span class="token punctuation">[</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>orc<span class="token punctuation">.</span>OrcFileFormat<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"orc"</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>总结: 在 Spark 2.3 以后, Spark 增加 <code>spark.sql.hive.convertMetastoreOrc</code> 参数, 设定 ORC 文件使用采用向量化 Reader, 但是会引申由于 Spark SQL 无法与 Hive SQL 采用同一 SerDe 从而对 Parquet/Hive 数据表产生处理上的不同, 因此需要限定如下参数从而让 Spark 使用 Hive 的SerDe.</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> spark<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">.</span>hive<span class="token punctuation">.</span>convertMetastoreOrc<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> spark<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">.</span>hive<span class="token punctuation">.</span>convertMetastoreParquet<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>
<h2 id="pyspark-报错-GLIBC-NOT-FOUND">pyspark 报错 GLIBC NOT FOUND</h2>
<blockquote>
<p>原因: 因集群部分节点系统版本较低,所以编译Python的机器中,glibc版本需要低于 2.14(可以使用<code>ls -l /lib64/libc.so.6</code>或者<code>ldd --version</code>查看),否则executor无法启动Python进程,会报错类似错误</p>
</blockquote>
<figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">Error from python worker:
  pythondir/python-3.7.10/bin/python3: /lib64/libc.so.6: version `GLIBC_2.14' not found (required by pythondir/python-3.7.10/bin/python3)
  pythondir/python-3.7.10/bin/python3: /lib64/libc.so.6: version `GLIBC_2.17' not found (required by pythondir/python-3.7.10/bin/python3)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>
<h3 id="编译-Python">编译 Python</h3>
<blockquote>
<p><code>python 3.7</code> 需要进行 <code>openssl</code> 编译, 而 <code>python 3.6</code> 则不需要, 如下步骤以 <code>python 3.7</code> 举例</p>
</blockquote>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 利用 docker 构建 GLIBC 环境</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> <span class="token string">"build_python"</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--cpus</span><span class="token operator">=</span><span class="token number">4</span> centos:centos6 /bin/bash
<span class="token comment"># 如下为 docker 内部运行命令</span>
<span class="token comment">## 替换源: 清华源等均已下架 Centos 6</span>
<span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org|baseurl=https://vault.centos.org|g'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-i.bak</span> <span class="token punctuation">\</span>
    /etc/yum.repos.d/CentOS-*.repo
<span class="token comment">## 安装必备包</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">wget</span> perl gcc gcc-c++ <span class="token function">zip</span> <span class="token function">unzip</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> ncurses-libs zlib-devel mysql-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel libffi-devel
<span class="token comment">## 下载openssl-1.0.2u版本并编译</span>
<span class="token builtin class-name">cd</span> ~ <span class="token operator">&amp;&amp;</span>
<span class="token function">wget</span> https://www.openssl.org/source/old/1.0.2/openssl-1.0.2u.tar.gz <span class="token operator">&amp;&amp;</span>
<span class="token function">tar</span> zxvf openssl-1.0.2u.tar.gz <span class="token operator">&amp;&amp;</span> 
<span class="token builtin class-name">cd</span> openssl-1.0.2u <span class="token operator">&amp;&amp;</span>
./config <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/output/openssl-1.0.2u <span class="token parameter variable">--openssldir</span><span class="token operator">=</span>/output/openssl-1.0.2u/openssl <span class="token operator">&amp;&amp;</span>
<span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
<span class="token comment">## 下载Python3.7 并配置</span>
<span class="token builtin class-name">cd</span> ~ <span class="token operator">&amp;&amp;</span>
<span class="token function">wget</span> https://npm.taobao.org/mirrors/python/3.7.10/Python-3.7.10.tgz <span class="token operator">&amp;&amp;</span>
<span class="token function">tar</span> zxvf Python-3.7.10.tgz <span class="token operator">&amp;&amp;</span> 
<span class="token builtin class-name">cd</span> Python-3.7.10 <span class="token operator">&amp;&amp;</span>
./configure --enable-optimizations <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/output/python-3.7.10
<span class="token comment">## 修改编译参数</span>
<span class="token function">vi</span> Modules/Setup
<span class="token comment">## 大约在221行左右,修改SSL路径,并且将这四行的注释去掉</span>
<span class="token assign-left variable">SSL</span><span class="token operator">=</span>/output/openssl-1.0.2u
_ssl _ssl.c <span class="token punctuation">\</span>
   <span class="token parameter variable">-DUSE_SSL</span> -I<span class="token variable"><span class="token variable">$(</span>SSL<span class="token variable">)</span></span>/include -I<span class="token variable"><span class="token variable">$(</span>SSL<span class="token variable">)</span></span>/include/openssl <span class="token punctuation">\</span>
   -L<span class="token variable"><span class="token variable">$(</span>SSL<span class="token variable">)</span></span>/lib <span class="token parameter variable">-lssl</span> <span class="token parameter variable">-lcrypto</span>
<span class="token comment">## 编译&amp;安装</span>
<span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
<span class="token comment">## 安装所需包</span>
<span class="token builtin class-name">cd</span> /output/python-3.7.10
./bin/pip3 config <span class="token builtin class-name">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
./bin/pip3 <span class="token function">install</span> YOUR_NEED_BAG
<span class="token comment">## 压缩Python</span>
<span class="token function">zip</span> <span class="token parameter variable">-r</span> python37.zip ./
<span class="token comment">## 获取libffi</span>
<span class="token builtin class-name">cd</span> /usr/lib64 <span class="token operator">&amp;&amp;</span>
<span class="token function">zip</span> <span class="token parameter variable">-r</span> libs.zip ./libffi.so.* <span class="token operator">&amp;&amp;</span>
<span class="token function">mv</span> libs.zip /output/
<span class="token comment"># 导出</span>
<span class="token function">docker</span> <span class="token function">cp</span> build_python:/output/python-3.7.10/python37.zip ~/Downloads
<span class="token function">docker</span> <span class="token function">cp</span> build_python:/output/libs.zip ~/Downloads
<span class="token comment"># 推送到hdfs</span>
hadoop fs <span class="token parameter variable">-put</span> ~/Downloads/python37.zip /YOUR_WORK_PATH/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<h2 id="参考资料">参考资料</h2>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%A1%86%E6%9E%B6/" class="category-chain-item">大数据框架</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Spark/" class="print-no-link">#Spark</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>【Spark笔记】 日常踩坑</div>
      <div>https://www.windism.space/3387433632.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>windism</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年6月7日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                    <i class="iconfont icon-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="ND - 禁止演绎">
                    <i class="iconfont icon-nd"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2209565849.html" title="Maven使用笔记总结">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Maven使用笔记总结</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/3797270078.html" title="【风控特征】通讯数据信息">
                        <span class="hidden-mobile">【风控特征】通讯数据信息</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="twikoo"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/twikoo/1.6.8/twikoo.all.min.js', function() {
        var options = Object.assign(
          {"envId":"http://twikoo.windism.space","region":null,"path":"window.location.pathname"},
          {
            el: '#twikoo',
            path: 'window.location.pathname',
            onCommentLoaded: function() {
              Fluid.utils.listenDOMLoaded(function() {
                var imgSelector = '#twikoo .tk-content img:not(.tk-owo-emotion)';
                Fluid.plugins.imageCaption(imgSelector);
                Fluid.plugins.fancyBox(imgSelector);
              });
            }
          }
        )
        twikoo.init(options)
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      京ICP备2023029279号
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
